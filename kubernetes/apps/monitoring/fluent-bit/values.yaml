podAnnotations:
  fluentbit.io/exclude: 'true'

tolerations:
  - operator: Exists
    effect: NoSchedule

config:
  service: |
    [SERVICE]
        Flush 5
        Daemon Off
        Log_Level warn
        Parsers_File custom_parsers.conf

  inputs: |
    # Collect container logs
    [INPUT]
        Name tail
        Path /var/log/containers/*.log
        Parser containerd
        Tag kube.*
        Mem_Buf_Limit 5MB
        Skip_Long_Lines On

    # Collect Talos logs (if configured to forward to port 12345)
    [INPUT]
        Name tcp
        Listen 0.0.0.0
        Port 12345
        Format json
        Tag talos.*

  filters: |
    # Kubernetes metadata filter
    [FILTER]
        Name kubernetes
        Match kube.*
        Merge_Log On
        Keep_Log Off
        K8S-Logging.Parser Off
        K8S-Logging.Exclude On

    # Modify records
    [FILTER]
        Name modify
        Match kube.*
        Add source kubernetes
        Remove logtag

  outputs: |
    # Send to OpenSearch
    [OUTPUT]
        Name  opensearch
        Match *
        Host  opensearch-cluster-master
        Port  9200
        Index fluent-bit
        Suppress_Type_Name On
        Logstash_Format On
        Logstash_Prefix logs
        Replace_Dots On
        Retry_Limit False
        tls Off

  customParsers: |
    [PARSER]
        Name containerd
        Format regex
        Regex ^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<log>.*)$
        Time_Key time
        Time_Format %Y-%m-%dT%H:%M:%S.%L%z

daemonSetVolumes:
  - name: varlog
    hostPath:
      path: /var/log
  - name: varlibdockercontainers
    hostPath:
      path: /var/lib/docker/containers

daemonSetVolumeMounts:
  - name: varlog
    mountPath: /var/log
  - name: varlibdockercontainers
    mountPath: /var/lib/docker/containers
    readOnly: true
