podAnnotations:
  fluentbit.io/exclude: 'true'

tolerations:
- operator: Exists
  effect: NoSchedule

readinessProbe:
  httpGet:
    path: /api/v1/health
    port: 2020
  initialDelaySeconds: 5
  periodSeconds: 10

metrics:
  enabled: true
  port: 2020
  path: /api/v1/health

config:
  service: |
    [SERVICE]
        Flush        5
        Daemon       Off
        Log_Level    warn
        Parsers_File /fluent-bit/etc/custom_parsers.conf
        HTTP_Server  On
        HTTP_Listen  0.0.0.0
        HTTP_Port    2020

  inputs: |
    [INPUT]
        Name              tail
        Path              /var/log/containers/*.log
        Parser            containerd
        Tag               kube.*
        Mem_Buf_Limit     5MB
        Skip_Long_Lines   On

    [INPUT]
        Name     tcp
        Listen   0.0.0.0
        Port     12345
        Format   json
        Tag      talos.*

  filters: |
    [FILTER]
        Name                kubernetes
        Match               kube.*
        Merge_Log           On
        Keep_Log            Off
        K8S-Logging.Parser  Off
        K8S-Logging.Exclude On

    [FILTER]
        Name   modify
        Match  kube.*
        Add    source kubernetes
        Remove logtag

  outputs: |
    [OUTPUT]
        Name               opensearch
        Match              *
        Host               opensearch-cluster-master
        Port               9200
        Index              fluent-bit
        Suppress_Type_Name On
        Logstash_Format    On
        Logstash_Prefix    logs
        Replace_Dots       On
        Retry_Limit        False
        tls                Off

  customParsers: |
    [PARSER]
        Name   containerd
        Format regex
        Regex  ^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<log>.*)$
        Time_Key time
        Time_Format %Y-%m-%dT%H:%M:%S.%L%z

volumeMounts:
- name: varlog
  mountPath: /var/log
- name: docker-containers
  mountPath: /var/lib/docker/containers
  readOnly: true
- name: custom-parsers
  mountPath: /fluent-bit/etc/custom_parsers.conf
  subPath: custom_parsers.conf
  readOnly: true

volumes:
- name: varlog
  hostPath:
    path: /var/log
- name: docker-containers
  hostPath:
    path: /var/lib/docker/containers
- name: custom-parsers
  configMap:
    name: fluent-bit-custom-parsers
