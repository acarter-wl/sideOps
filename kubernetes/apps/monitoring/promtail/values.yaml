daemonset:
  enabled: true

config:
  server:
    http_listen_port: 3101
    grpc_listen_port: 0

  positions:
    filename: /var/promtail/positions.yaml

  clients:
    - url: http://loki-gateway.monitoring.svc.cluster.local/loki/api/v1/push

  scrape_configs:
    - job_name: kubernetes-pods
      pipeline_stages:
        - cri: {}
      kubernetes_sd_configs:
        - role: pod
      relabel_configs:
        - source_labels: [ __meta_kubernetes_pod_label_name ]
          target_label: __service__
        - source_labels: [ __meta_kubernetes_namespace ]
          target_label: namespace
        - source_labels: [ __meta_kubernetes_pod_name ]
          target_label: pod
        - action: labelmap
          regex: __meta_kubernetes_pod_label_(.+)
        - source_labels: [ __meta_kubernetes_pod_node_name ]
          target_label: __host__

    - job_name: kubernetes-nodes
      static_configs:
        - targets:
            - localhost
          labels:
            job: varlogs
            __path__: /var/log/*.log

    - job_name: kubernetes-system
      static_configs:
        - targets:
            - localhost
          labels:
            job: containers
            __path__: /var/log/containers/*.log

extraVolumes:
  - name: promtail-writable
    emptyDir: {}
  - name: varlog
    hostPath:
      path: /var/log
  - name: varlibdockercontainers
    hostPath:
      path: /var/lib/docker/containers

extraVolumeMounts:
  - name: promtail-writable
    mountPath: /var/promtail
  - name: varlog
    mountPath: /var/log
    readOnly: true
  - name: varlibdockercontainers
    mountPath: /var/lib/docker/containers
    readOnly: true

serviceMonitor:
  enabled: true
  additionalLabels:
    release: kube-prometheus-stack
