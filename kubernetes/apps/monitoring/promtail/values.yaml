daemonset:
  enabled: true
  # Add volume configuration
  volumes:
    - name: positions
      hostPath:
        path: /var/promtail
        type: DirectoryOrCreate
  volumeMounts:
    - name: positions
      mountPath: /var/promtail

config:
  server:
    http_listen_port: 3101
    grpc_listen_port: 0

  positions:
    filename: /var/promtail/positions.yaml
  clients:
    - url: http://loki.monitoring.svc.cluster.local/loki/api/v1/push
      # Add backoff_config to handle connection issues
      backoff_config:
        min_period: 100ms
        max_period: 10s
        max_retries: 10
      # Add timeout to prevent hanging connections
      timeout: 10s

  scrape_configs:
    - job_name: kubernetes-pods
      pipeline_stages:
        - cri: {}
      kubernetes_sd_configs:
        - role: pod
      relabel_configs:
        - source_labels: [ __meta_kubernetes_pod_label_name ]
          target_label: __service__
        - source_labels: [ __meta_kubernetes_namespace ]
          target_label: namespace
        - source_labels: [ __meta_kubernetes_pod_name ]
          target_label: pod
        - action: labelmap
          regex: __meta_kubernetes_pod_label_(.+)
        - source_labels: [ __meta_kubernetes_pod_node_name ]
          target_label: __host__

    - job_name: kubernetes-nodes
      static_configs:
        - targets:
            - localhost
          labels:
            job: varlogs
            __path__: /var/log/*.log

    - job_name: kubernetes-system
      static_configs:
        - targets:
            - localhost
          labels:
            job: containers
            __path__: /var/log/containers/*.log

serviceMonitor:
  enabled: true
  additionalLabels:
    release: kube-prometheus-stack

# Add security context to ensure proper permissions
securityContext:
  runAsUser: 0 # Run as root to ensure access to log files
  privileged: true
