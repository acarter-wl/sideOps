---
# Values file for k8s-monitoring chart optimized for Talos Linux
# that utilizes Talos' built-in Loki integration
cluster:
  name: "kubernetes"

global:
  scrapeInterval: 30s
  maxCacheSize: 100000

# Define destinations where telemetry will be sent
destinations:
  - name: "lokistack"
    type: "loki"
    loki:
      url: "http://loki.monitoring.svc.cluster.local:3100/loki/api/v1/push"
  - name: "prometheusstack"
    type: "prometheus"
    prometheus:
      url: "http://prometheus.monitoring.svc.cluster.local:9090/api/v1/write"

# Enable cluster metrics collection
clusterMetrics:
  enabled: true
  destinations: [ "prometheusstack" ]

# Enable cluster events collection
clusterEvents:
  enabled: true
  destinations: [ "lokistack" ]

# DISABLE node logs collection since Talos is already sending logs directly to Loki
# via the machine configuration
nodeLogs:
  enabled: false

# Enable pod logs collection
podLogs:
  enabled: true
  destinations: [ "lokistack" ]

# Enable Prometheus operator objects integration
prometheusOperatorObjects:
  enabled: true
  destinations: [ "prometheusstack" ]

# Enable the alloy-metrics collector (required for clusterMetrics)
alloy-metrics:
  enabled: true
  controller:
    type: statefulset
    replicas: 1
    tolerations:
      - effect: NoSchedule
        operator: Exists
      # Add Talos control plane tolerations
      - key: node-role.kubernetes.io/control-plane
        operator: Exists
        effect: NoSchedule
      - key: node-role.kubernetes.io/master
        operator: Exists
        effect: NoSchedule

# Configure the alloy-logs DaemonSet for Talos
# Focus only on collecting container logs, not host logs
alloy-logs:
  enabled: true
  controller:
    type: daemonset
    tolerations:
      - effect: NoSchedule
        operator: Exists
      # Add Talos control plane tolerations
      - key: node-role.kubernetes.io/control-plane
        operator: Exists
        effect: NoSchedule
      - key: node-role.kubernetes.io/master
        operator: Exists
        effect: NoSchedule

  # Mount locations specific to Talos Linux
  alloy:
    mounts:
      varlog: true
      dockercontainers: false # Talos uses containerd, not Docker

# Enable singleton for other features
alloy-singleton:
  enabled: true
  controller:
    type: deployment
    replicas: 1
    tolerations:
      - effect: NoSchedule
        operator: Exists
      # Add Talos control plane tolerations
      - key: node-role.kubernetes.io/control-plane
        operator: Exists
        effect: NoSchedule
      - key: node-role.kubernetes.io/master
        operator: Exists
        effect: NoSchedule

# Self-reporting can be disabled if desired
selfReporting:
  enabled: false
