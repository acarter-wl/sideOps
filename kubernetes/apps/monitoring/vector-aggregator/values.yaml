role: "Stateless-Aggregator"

customConfig:
  data_dir: /vector-data-dir

  # Sources for aggregator
  sources:
    vector_in:
      type: vector
      address: 0.0.0.0:6000
      version: "2"

    # Add internal metrics source for Prometheus
    internal_metrics:
      type: internal_metrics

  # Transforms for aggregator
  transforms:
    # Route logs by type - Fixed syntax for conditions
    route_logs:
      type: route
      inputs:
        - vector_in
      route:
        kubernetes:
          type: vrl
          source: |
            .log_type == "kubernetes"
        talos_kernel:
          type: vrl
          source: |
            .log_type == "talos_kernel"
        talos_service:
          type: vrl
          source: |
            .log_type == "talos_service"
        # Add a catch-all route for unmatched logs
        unmatched:
          type: vrl
          source: |
            true

    # Final processing for each log type
    kubernetes_final:
      type: remap
      inputs:
        - route_logs.kubernetes
      source: |
        # Final enrichment for k8s logs
        .timestamp = now()

    talos_kernel_final:
      type: remap
      inputs:
        - route_logs.talos_kernel
      source: |
        # Final enrichment for kernel logs
        .timestamp = now()

    talos_service_final:
      type: remap
      inputs:
        - route_logs.talos_service
      source: |
        # Ensure timestamp is set
        .timestamp = now()

        # Set default service if not present
        if !exists(.service) {
          .service = "unknown"
        }

        # Extract service name from msg if available
        if exists(.msg) {
          msg_str = string!(.msg)

          # Check for MachineService
          if msg_str =~ "MachineService" {
            .service = "machined"

            # Try to extract API call
            parts = split(msg_str, "[")
            if length(parts) >= 2 {
              api_part = split(parts[1], "]")[0]
              if length(api_part) > 0 {
                .api_call = api_part
              }
            }
          }

          # Try to extract duration
          duration_match = parse_regex(msg_str, r'(?P<duration>\d+\.\d+)(Âµ|m|n)?s') ?? {}
          if exists(duration_match.duration) {
            .duration = to_float(duration_match.duration)
          }
        }

    # Process unmatched logs
    unmatched_logs:
      type: remap
      inputs:
        - route_logs.unmatched
      source: |
        .timestamp = now()
        .log_type = "unmatched"

        # Try to categorize unmatched logs if possible
        if exists(.msg) {
          msg = string!(.msg)
          if msg =~ "machined" {
            .log_type = "talos_service"
            .service = "machined"
          }
        }

        # Check for DNS component
        if exists(.component) && .component == "dns-resolve-cache" {
          .log_type = "talos_service"
          .service = "dns"
        }

    # Optional: Consolidated logs for stdout
    all_logs_agg:
      type: remap
      inputs:
        - kubernetes_final
        - talos_kernel_final
        - talos_service_final
        - unmatched_logs
      source: |
        .timestamp = now()
        .source = "aggregator"

  # Sinks
  sinks:
    # Loki sinks
    loki_kubernetes:
      type: loki
      inputs:
        - kubernetes_final
      endpoint: "http://loki-gateway"
      encoding:
        codec: json
      labels:
        pod: "{{`{{ pod }}`}}"
        namespace: "{{`{{ namespace }}`}}"
        container: "{{`{{ container }}`}}"
        node: "{{`{{ node }}`}}"
        log_type: "kubernetes"
      batch:
        max_bytes: 2097152
        timeout_secs: 5
      out_of_order_action: rewrite_timestamp

    loki_talos_kernel:
      type: loki
      inputs:
        - talos_kernel_final
      endpoint: "http://loki-gateway"
      encoding:
        codec: json
        except_fields:
          - __host
      labels:
        hostname: "{{`{{ node }}`}}"
        facility: "{{`{{ facility }}`}}"
        log_type: "talos_kernel"
      batch:
        max_bytes: 2097152
        timeout_secs: 5
      out_of_order_action: rewrite_timestamp

    loki_talos_service:
      type: loki
      inputs:
        - talos_service_final
        - unmatched_logs
      endpoint: "http://loki-gateway"
      encoding:
        codec: json
        except_fields:
          - __host
      labels:
        hostname: "{{`{{ node }}`}}"
        service: "{{`{{ service }}`}}"
        component: "{{`{{ component }}`}}"
        log_type: "{{`{{ log_type }}`}}"
      batch:
        max_bytes: 1048576
        timeout_secs: 5
      out_of_order_action: rewrite_timestamp

    # Optional: Console output for debugging
    stdout:
      type: console
      inputs:
        - all_logs_agg
      encoding:
        codec: json

    # Prometheus metrics - fixed to use internal_metrics source
    prometheus:
      type: prometheus_exporter
      inputs:
        - internal_metrics
      address: 0.0.0.0:9598

# Deployment settings for the aggregator
replicas: 2

# PodDisruptionBudget for the aggregator
podDisruptionBudget:
  minAvailable: 1

# Service for the aggregator
service:
  ports:
    - name: vector-ingress
      port: 6000
      targetPort: 6000
      protocol: TCP
    - name: prom-exporter
      port: 9598
      targetPort: 9598
      protocol: TCP

# Resources for the aggregator
resources:
  limits:
    cpu: 1000m
    memory: 1Gi
  requests:
    cpu: 200m
    memory: 512Mi
