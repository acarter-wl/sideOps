global:
  imagePullSecrets: []
  cluster:
    dnsDomain: cluster.local

vlselect:
  enabled: true
  replicaCount: 2
  service:
    enabled: true
    type: ClusterIP
  ingress:
    enabled: true
    annotations:
      kubernetes.io/ingress.class: internal
      cert-manager.io/cluster-issuer: letsencrypt-production
    extraLabels: {}
    hosts:
      - name: logs.wakkalabs.com
        path:
          - /select
        port: http
    tls:
      - secretName: vlogs-select-tls
        hosts:
          - logs.wakkalabs.com
    ingressClassName: internal
    pathType: Prefix
  vmServiceScrape:
    enabled: true
    useServiceMonitor: false
    extraLabels:
      release: victoria-metrics
  extraArgs:
    envflag.enable: true
    loggerFormat: json
    httpListenAddr: :9471

vlinsert:
  enabled: true
  replicaCount: 2
  service:
    enabled: true
    type: ClusterIP
  ingress:
    enabled: true
    annotations:
      kubernetes.io/ingress.class: internal
      cert-manager.io/cluster-issuer: letsencrypt-production
    hosts:
      - name: logs.wakkalabs.com
        path:
          - /insert
        port: http
    tls:
      - secretName: vlogs-insert-tls
        hosts:
          - logs.wakkalabs.com
    ingressClassName: internal
    pathType: Prefix
  vmServiceScrape:
    enabled: true
    useServiceMonitor: false
    extraLabels:
      release: victoria-metrics
  extraArgs:
    envflag.enable: true
    loggerFormat: json
    httpListenAddr: :9481

vlstorage:
  enabled: true
  replicaCount: 2
  persistentVolume:
    enabled: true
    accessModes:
      - ReadWriteOnce
    size: 20Gi
  vmServiceScrape:
    enabled: true
    useServiceMonitor: false
    extraLabels:
      release: victoria-metrics
  retentionPeriod: 30d
  extraArgs:
    envflag.enable: true
    loggerFormat: json
    httpListenAddr: :9491

vmauth:
  enabled: false
  # replicaCount: 2
  # config:
  #   users:
  #     - username: "admin"
  #       password: "CHANGEME"
  #       url_map:
  #         - src_paths:
  #             - "/select"
  #           dst_url: "http://victoria-logs-cluster-vlselect.monitoring.svc:9471/select"
  #         - src_paths:
  #             - "/insert"
  #           dst_url: "http://victoria-logs-cluster-vlinsert.monitoring.svc:9481/insert"
  ingress:
    enabled: true
    annotations:
      kubernetes.io/ingress.class: internal
      cert-manager.io/cluster-issuer: letsencrypt-production
    hosts:
      - name: logs.wakkalabs.com
        path:
          - /
        port: http
    tls:
      - secretName: vlogs-vmauth-tls
        hosts:
          - logs.wakkalabs.com
    ingressClassName: internal
    pathType: Prefix
  vmServiceScrape:
    enabled: true
    useServiceMonitor: false
    extraLabels:
      release: victoria-metrics

# Vector configuration - the key fix here is using the 'existingConfigMap' approach
vector:
  enabled: true
  role: Stateless-Aggregator
  dataDir: /vector-data-dir
  # Create the config separately
  existingConfigMaps:
    - vector-talos-config
  # Define container environment variables
  env:
    - name: VECTOR_SELF_NODE_NAME
      valueFrom:
        fieldRef:
          fieldPath: spec.nodeName
    - name: VECTOR_SELF_POD_NAME
      valueFrom:
        fieldRef:
          fieldPath: metadata.name
    - name: VECTOR_SELF_POD_NAMESPACE
      valueFrom:
        fieldRef:
          fieldPath: metadata.namespace
  # Define the service
  service:
    enabled: true
    type: LoadBalancer
    ports:
      - name: talos-kernel
        port: 6050
        protocol: UDP
        targetPort: 6050
      - name: talos-service
        port: 6051
        protocol: UDP
        targetPort: 6051
  # Resources
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 1000m
      memory: 512Mi
  # Container arguments
  args:
    - -w
    - --config-dir
    - /etc/vector/
  # Container ports
  containerPorts:
    - name: prom-exporter
      containerPort: 9090
      protocol: TCP
    - name: talos-kernel
      containerPort: 6050
      protocol: UDP
    - name: talos-service
      containerPort: 6051
      protocol: UDP
  # Define the Vector config separately in a ConfigMap
  customConfig:
    data_dir: /vector-data-dir
    api:
      enabled: false
      address: 0.0.0.0:8686
