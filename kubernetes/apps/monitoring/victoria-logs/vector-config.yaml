apiVersion: v1
kind: ConfigMap
metadata:
  name: vl-vector-talos-config
  namespace: monitoring
data:
  vector.yaml: |
    role: Stateless-Aggregator
    data_dir: /vector-data-dir
    api:
      enabled: false
      address: 0.0.0.0:8686

    sources:
      # Kubernetes logs source
      k8s:
        type: kubernetes_logs
        self_node_name: "${VECTOR_SELF_NODE_NAME}"

      # Internal metrics
      internal_metrics:
        type: internal_metrics

      # Talos kernel logs source
      talos_kernel_logs:
        address: 0.0.0.0:6050
        type: socket
        mode: udp
        max_length: 102400
        decoding:
          codec: json
        host_key: __host

      # Talos service logs source
      talos_service_logs:
        address: 0.0.0.0:6051
        type: socket
        mode: udp
        max_length: 102400
        decoding:
          codec: json
        host_key: __host

    transforms:
      # K8s logs parser
      k8s_parser:
        type: remap
        inputs: [k8s]
        source: |
          .timestamp = now()
          . = parse_json!(.message) ?? .message

      # Talos kernel logs transform
      talos_kernel_logs_xform:
        type: remap
        inputs: [talos_kernel_logs]
        source: |
          .source_type = "talos_kernel"

      # Talos service logs transform
      talos_service_logs_xform:
        type: remap
        inputs: [talos_service_logs]
        source: |
          .source_type = "talos_service"

    sinks:
      # Metrics sink for VictoriaMetrics
      metrics:
        type: prometheus_remote_write
        inputs: [internal_metrics]
        endpoint: http://vminsert-victoria-metrics-k8s-stack.monitoring.svc:8480/api/v1/write

      # K8s logs sink
      k8s_logs_sink:
        type: http
        inputs: [k8s_parser]
        method: post
        uri: http://victoria-logs-single-server.monitoring.svc:9428/insert/loki/api/v1/push
        encoding:
          codec: json
        request:
          headers:
            Content-Type: application/json
            VL-Time-Field: timestamp
            VL-Stream-Fields: stream,kubernetes.pod_name,kubernetes.container_name,kubernetes.pod_namespace
            VL-Msg-Field: message,msg,_msg,log.msg,log.message,log

      # Talos kernel logs sink
      talos_kernel:
        type: http
        inputs: [talos_kernel_logs_xform]
        method: post
        uri: http://victoria-logs-single-server.monitoring.svc:9428/insert/loki/api/v1/push
        encoding:
          codec: json
          except_fields:
            - __host
        batch:
          max_bytes: 1048576
        request:
          headers:
            Content-Type: application/json
            VL-Time-Field: timestamp
            VL-Stream-Fields: hostname,facility,source_type
            VL-Msg-Field: message,msg
            VL-Out-Of-Order-Action: rewrite_timestamp

      # Talos service logs sink
      talos_service:
        type: http
        inputs: [talos_service_logs_xform]
        method: post
        uri: http://victoria-logs-single-server.monitoring.svc:9428/insert/loki/api/v1/push
        encoding:
          codec: json
          except_fields:
            - __host
        batch:
          max_bytes: 400000
        request:
          headers:
            Content-Type: application/json
            VL-Time-Field: timestamp
            VL-Stream-Fields: hostname,service,source_type
            VL-Msg-Field: message,msg
            VL-Out-Of-Order-Action: rewrite_timestamp
