# vector-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: vector-talos-config
  namespace: monitoring
data:
  vector.yaml: |
    data_dir: /vector-data-dir
    api:
      enabled: false
      address: 0.0.0.0:8686
    sources:
      # Changed name from k8s_logs to k8s to match what you have in the logs
      k8s:
        type: kubernetes_logs
        self_node_name: "${VECTOR_SELF_NODE_NAME}"
      internal_metrics:
        type: internal_metrics
      talos_kernel_logs:
        address: 0.0.0.0:6050
        type: socket
        mode: udp
        max_length: 102400
        decoding:
          codec: json
        host_key: __host
      talos_service_logs:
        address: 0.0.0.0:6051
        type: socket
        mode: udp
        max_length: 102400
        decoding:
          codec: json
        host_key: __host
    transforms:
      k8s_parser:
        type: remap
        # Changed input to match source name 'k8s' instead of 'k8s_logs'
        inputs: [ k8s ]
        source: |
          .timestamp = now()
          . = parse_json!(.message)
      talos_kernel_logs_xform:
        type: remap
        inputs: [ talos_kernel_logs ]
        source: |
          .source_type = "talos_kernel"
      talos_service_logs_xform:
        type: remap
        inputs: [ talos_service_logs ]
        source: |
          .source_type = "talos_service"
    sinks:
      metrics:
        type: prometheus_remote_write
        inputs: [ internal_metrics ]
        endpoint: http://vminsert-victoria-metrics-k8s-stack.monitoring.svc:8480/api/v1/write
      # Renamed from k8s_logs_sink to avoid conflict
      k8s_logs_sink:
        type: http
        inputs: [ k8s_parser ]
        method: post
        uri: http://victoria-logs-cluster-vlinsert.monitoring.svc:9481/insert/loki/api/v1/push
        encoding:
          codec: json
        request:
          headers:
            Content-Type: application/json
            VL-Time-Field: timestamp
            VL-Stream-Fields: stream,kubernetes.pod_name,kubernetes.container_name,kubernetes.pod_namespace
            VL-Msg-Field: message,msg,_msg,log.msg,log.message,log
      talos_kernel:
        type: http
        inputs: [ talos_kernel_logs_xform ]
        method: post
        uri: http://victoria-logs-cluster-vlinsert.monitoring.svc:9481/insert/loki/api/v1/push
        encoding:
          codec: json
          except_fields:
            - __host
        batch:
          max_bytes: 1048576
        request:
          headers:
            Content-Type: application/json
            VL-Time-Field: timestamp
            VL-Stream-Fields: hostname,facility,source_type
            VL-Msg-Field: message,msg
            VL-Out-Of-Order-Action: rewrite_timestamp
      talos_service:
        type: http
        inputs: [ talos_service_logs_xform ]
        method: post
        uri: http://victoria-logs-cluster-vlinsert.monitoring.svc:9481/insert/loki/api/v1/push
        encoding:
          codec: json
          except_fields:
            - __host
        batch:
          max_bytes: 400000
        request:
          headers:
            Content-Type: application/json
            VL-Time-Field: timestamp
            VL-Stream-Fields: hostname,service,source_type
            VL-Msg-Field: message,msg
            VL-Out-Of-Order-Action: rewrite_timestamp
