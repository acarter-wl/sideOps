apiVersion: v1
kind: ConfigMap
metadata:
  name: vector-config
  namespace: monitoring
data:
  vector.yaml: |
    data_dir: /vector-data-dir

    sources:
      kubernetes_logs:
        type: kubernetes_logs
        self_node_name: ${VECTOR_SELF_NODE_NAME}

      talos_kernel_logs:
        address: 0.0.0.0:6050
        type: socket
        mode: udp
        max_length: 102400
        decoding:
          codec: json
        host_key: __host

      talos_service_logs:
        address: 0.0.0.0:6051
        type: socket
        mode: udp
        max_length: 102400
        decoding:
          codec: json
        host_key: __host

      internal_metrics:
        type: internal_metrics

    transforms:
      kubernetes_logs_size_limiter:
        type: remap
        inputs: [kubernetes_logs]
        source: |
          .message = string(.message) ?? ""
          # Fallibility of slice handled, warning about unused err is present but not critical
          .message, err = slice(.message, 0, 131072) + " ... [truncated]"

      kubernetes_logs_transform:
        type: remap
        inputs: [kubernetes_logs_size_limiter]
        source: |
          .container = .kubernetes.container_name
          .pod = .kubernetes.pod_name
          .namespace = .kubernetes.pod_namespace
          .node = get_env_var("HOSTNAME") ?? "unknown"
          .log_type = "kubernetes"
          .timestamp = now()

      talos_kernel_transform:
        type: remap
        inputs: [talos_kernel_logs]
        source: |
          .node = .__host
          if exists(.facility) {
            .facility = .facility
          } else {
            .facility = "kernel"
          }
          .log_type = "talos_kernel"
          .timestamp = now()

      talos_kernel_transform_remove_host:
        type: remap
        inputs: [talos_kernel_transform]
        source: del(.__host)

      talos_service_transform:
        type: remap
        inputs: [talos_service_logs]
        source: |
          .node = .__host
          if exists(.service) {
            .service = .service
          } else {
            .service = "talos-service"
          }
          .log_type = "talos_service"
          if exists(.msg) {
            # Corrected: Handle fallible to_string conversion
            msg, err = to_string(.msg)
            # Note: err from to_string is not explicitly handled here.
            # The following contains checks will likely fail gracefully
            # if msg is not a string due to conversion error.
            if contains(msg, "machined") {
              .service = "machined"
            } else if contains(msg, "containerd") {
              .service = "containerd"
            } else if contains(msg, "kubelet") {
              .service = "kubelet"
            } else if contains(msg, "apid") {
              .service = "apid"
            } else if contains(msg, "trustd") {
              .service = "trustd"
            }
          }
          .timestamp = now()

      talos_service_transform_remove_host:
        type: remap
        inputs: [talos_service_transform]
        source: del(.__host)

    sinks:
      loki_kubernetes:
        type: loki
        inputs: [kubernetes_logs_transform]
        endpoint: http://loki.monitoring.svc:3100
        encoding:
          codec: json
        labels:
          pod: "{{ pod }}"
          namespace: "{{ namespace }}"
          container: "{{ container }}"
          node: "{{ node }}"
          log_type: "kubernetes"
        batch:
          max_bytes: 262144
          timeout_secs: 4
          max_events: 50
        request:
          retry_attempts: 2
          retry_initial_backoff_secs: 1
          retry_max_duration_secs: 5
          rate_limit_num: 5
          rate_limit_duration_secs: 2
        out_of_order_action: rewrite_timestamp

      loki_talos_kernel:
        type: loki
        inputs: [talos_kernel_transform_remove_host]
        endpoint: http://loki.monitoring.svc:3100
        encoding:
          codec: json
        labels:
          hostname: "{{ node }}"
          facility: "{{ facility }}"
          log_type: "talos_kernel"
        batch:
          max_bytes: 262144
          timeout_secs: 4
          max_events: 50
        request:
          retry_attempts: 2
          retry_initial_backoff_secs: 1
          retry_max_duration_secs: 5
          rate_limit_num: 5
          rate_limit_duration_secs: 2
        out_of_order_action: rewrite_timestamp

      loki_talos_service:
        type: loki
        inputs: [talos_service_transform_remove_host]
        endpoint: http://loki.monitoring.svc:3100
        encoding:
          codec: json
        labels:
          hostname: "{{ node }}"
          service: "{{ service }}"
          log_type: "talos_service"
        batch:
          max_bytes: 262144
          timeout_secs: 4
          max_events: 50
        request:
          retry_attempts: 2
          retry_initial_backoff_secs: 1
          retry_max_duration_secs: 5
          rate_limit_num: 5
          rate_limit_duration_secs: 2
        out_of_order_action: rewrite_timestamp

      stdout:
        type: console
        inputs:
          - kubernetes_logs_transform
          - talos_kernel_transform_remove_host
          - talos_service_transform_remove_host
        encoding:
          codec: json

      prometheus:
        type: prometheus_exporter
        inputs: [internal_metrics]
        address: "0.0.0.0:9598"
