# kubernetes/apps/monitoring/vector-agent/values.yaml
role: "Agent"

customConfig:
  data_dir: /vector-data-dir

  # Sources
  sources:
    kubernetes_logs:
      type: kubernetes_logs
      include_paths_glob_patterns:
        - /var/log/pods/*/*.log
        - /var/lib/docker/containers/*/*.log
      exclude_paths_glob_patterns:
        - /var/log/pods/*/kube-proxy/**/*.log
        - /var/log/pods/vector-*/vector/*.log

    host_metrics:
      type: host_metrics
      collectors:
        - cpu
        - memory
        - network
        - load
      namespace: host
      scrape_interval_secs: 15

    talos_kernel_logs:
      address: 0.0.0.0:6050
      type: socket
      mode: udp
      max_length: 102400
      decoding:
        codec: json
      host_key: __host

    talos_service_logs:
      address: 0.0.0.0:6051
      type: socket
      mode: udp
      max_length: 102400
      decoding:
        codec: json
      host_key: __host

  # Transforms
  transforms:
    kubernetes_logs_transform:
      type: remap
      inputs:
        - kubernetes_logs
      source: |
        .message = .message
        .container = .kubernetes.container_name
        .pod = .kubernetes.pod_name
        .namespace = .kubernetes.pod_namespace
        .stream = .stream
        # Fixed error handling for env var
        .node = "unknown"
        hostname = get_env_var("HOSTNAME") ?? null
        if hostname != null {
          .node = hostname
        }
        .log_type = "kubernetes"
        .timestamp = now()

    talos_kernel_transform:
      type: remap
      inputs:
        - talos_kernel_logs
      source: |
        .node = .__host
        # Use if() with proper null check
        if exists(.facility) {
          .facility = .facility
        } else {
          .facility = "kernel"
        }
        .log_type = "talos_kernel"
        .timestamp = now()

    talos_service_transform:
      type: remap
      inputs:
        - talos_service_logs
      source: |
        # Set node from host
        .node = .__host

        # Determine service name with clear precedence
        resolved_service = "talos-service" # Default value

        if exists(.service) { # Prioritize existing .service field
          resolved_service = .service
        }

        # Attempt to derive a more specific service from .msg content
        if exists(.msg) && is_string(.msg) {
          msg_content = .msg
          if match!(msg_content, /machined/) {
            resolved_service = "machined"
          } else if match!(msg_content, /containerd/) {
            resolved_service = "containerd"
          } else if match!(msg_content, /kubelet/) {
            resolved_service = "kubelet"
          } else if match!(msg_content, /apid/) {
            resolved_service = "apid"
          } else if match!(msg_content, /trustd/) {
            resolved_service = "trustd"
          }
          # If .msg doesn't match known patterns, resolved_service retains its previous value
        }
        .service = resolved_service # Assign the final service name

        # Handle component field if it exists
        if exists(.component) {
          .component = .component
        }

        # Explicitly set log_type for proper routing
        .log_type = "talos_service"
        .timestamp = now()

    # Optional: for local stdout logging
    all_logs_stdout:
      type: remap
      inputs:
        - kubernetes_logs_transform
        - talos_kernel_transform
        - talos_service_transform
      source: |
        .timestamp = now()
        .source = "agent"

  # Sinks
  sinks:
    # Forward to aggregator
    aggregator:
      type: vector
      inputs:
        - kubernetes_logs_transform
        - talos_kernel_transform
        - talos_service_transform
      address: "http://vector-aggregator:6000"
      healthcheck: true
      compression: true

    # Optional: Console output for debugging
    stdout:
      type: console
      inputs:
        - all_logs_stdout
      encoding:
        codec: json

    # Prometheus metrics endpoint
    prometheus:
      type: prometheus_exporter
      inputs:
        - host_metrics
      address: 0.0.0.0:9598

# Tolerations to run on all nodes
tolerations:
  - operator: Exists

# Service for the agent
service:
  type: LoadBalancer
  ports:
    - name: prom-exporter
      port: 9598
      targetPort: 9598
      protocol: TCP
    - name: talos-kernel
      port: 6050
      targetPort: 6050
      protocol: UDP
    - name: talos-service
      port: 6051
      targetPort: 6051
      protocol: UDP

# Resources for the agent
resources:
  limits:
    cpu: 500m
    memory: 256Mi
  requests:
    cpu: 100m
    memory: 128Mi
