role: "Agent"

customConfig:
  data_dir: /vector-data-dir

  sources:
    tailscale_logs:
      type: splunk_hec
      address: "0.0.0.0:8088"
      tls:
        enabled: false
      # If you want to use token auth, uncomment and set a secure token
      # valid_tokens:
      #   - "your-secure-token-here"

    nginx_access_logs:
      type: file
      include:
        - /var/log/nginx/access.log
      read_from: beginning
      ignore_older_secs: 86400 # 1 day

    kubernetes_logs:
      type: kubernetes_logs

    talos_kernel_logs:
      address: 0.0.0.0:6050
      type: socket
      mode: udp
      max_length: 102400
      decoding:
        codec: json
      host_key: __host

    talos_service_logs:
      address: 0.0.0.0:6051
      type: socket
      mode: udp
      max_length: 102400
      decoding:
        codec: json
      host_key: __host

    internal_metrics:
      type: internal_metrics

  transforms:
    # Transform Tailscale logs
    tailscale_logs_transform:
      type: remap
      inputs: [tailscale_logs]
      source: |
        # Extract relevant fields from Tailscale logs
        .log_type = "tailscale"
        if exists(.ts) {
          .timestamp = parse_timestamp!(.ts, format: "%+")
        } else {
          .timestamp = now()
        }
        if exists(.src) {
          .source_ip = .src
        }
        if exists(.dst) {
          .destination_ip = .dst
        }

    # Log to metrics transforms
    kubernetes_log_metrics:
      type: log_to_metric
      inputs: [kubernetes_logs_transform]
      metrics:
        - type: counter
          name: kubernetes_logs_total
          field: message
          tags:
            namespace: "namespace"
            pod: "pod"
            container: "container"

    nginx_logs_metrics:
      type: log_to_metric
      inputs: [nginx_access_parser]
      metrics:
        - type: counter
          name: nginx_requests_total
          field: status
          tags:
            status: "status"
            method: "method"
            host: "host"

    nginx_access_parser:
      type: remap
      inputs:
        - nginx_access_logs
      source: |
        # Parse NGINX access logs
        . = parse_regex!(.message, r'^(?P<remote_addr>[^ ]+) - (?P<remote_user>[^ ]+) \[(?P<time_local>[^\]]+)\] "(?P<request_method>\S+) (?P<request_uri>\S+) (?P<server_protocol>[^"]+)" (?P<status>\d+) (?P<body_bytes_sent>\d+) "(?P<http_referer>[^"]*)" "(?P<http_user_agent>[^"]*)"$')
        .timestamp = parse_timestamp!(.time_local, format: "%d/%b/%Y:%H:%M:%S %z")
        .http_status = to_int!(.status)
        .bytes_sent = to_int!(.body_bytes_sent)
        .host = get_env_var("HOSTNAME") ?? "unknown"
        .log_type = "nginx_access"

        if exists(.request_uri) {
          uri_parts = split!(.request_uri, "?", limit: 2)
          .path = uri_parts[0]
          if length(uri_parts) > 1 {
            .query = uri_parts[1]
          }
        }
    kubernetes_logs_transform:
      type: remap
      inputs: [kubernetes_logs]
      source: |
        .container = .kubernetes.container_name
        .pod = .kubernetes.pod_name
        .namespace = .kubernetes.pod_namespace
        .node = get_env_var("HOSTNAME") ?? "unknown"
        .log_type = "kubernetes"
        .timestamp = now()

    talos_kernel_transform:
      type: remap
      inputs: [talos_kernel_logs]
      source: |
        .node = .__host
        .facility = if exists(.facility) && .facility != null { .facility } else { "kernel" }
        .log_type = "talos_kernel"
        .timestamp = now()

    talos_service_transform:
      type: remap
      inputs: [talos_service_logs]
      source: |
        .node = .__host
        .service = if exists(.service) && .service != null { .service } else { "talos-service" }
        if exists(.msg) {
          msg = to_string(.msg) ?? ""
          if contains(msg, "machined") {
            .service = "machined"
          } else if contains(msg, "containerd") {
            .service = "containerd"
          } else if contains(msg, "kubelet") {
            .service = "kubelet"
          } else if contains(msg, "apid") {
            .service = "apid"
          } else if contains(msg, "trustd") {
            .service = "trustd"
          }
        }
        .log_type = "talos_service"
        .timestamp = now()

  sinks:
    # Add Tailscale logs to Loki
    loki_tailscale:
      type: loki
      inputs: [tailscale_logs_transform]
      request:
        headers:
          X-Scope-OrgID: "1"
      endpoint: http://loki-gateway.monitoring.svc.cluster.local
      encoding:
        codec: json
      labels:
        src: "source_ip"
        dst: "destination_ip"
        log_type: "tailscale"
      batch:
        max_bytes: 1048576
        timeout_secs: 5
      out_of_order_action: rewrite_timestamp

    loki_nginx_access:
      type: loki
      inputs: [nginx_access_parser]
      request:
        headers:
          X-Scope-OrgID: "1"
      endpoint: http://loki-gateway.monitoring.svc.cluster.local
      encoding:
        codec: json
      labels:
        host: "host"
        status: "status"
        method: "request_method"
        log_type: "nginx_access"
      batch:
        max_bytes: 1048576
        timeout_secs: 5
    loki_kubernetes:
      type: loki
      inputs: [kubernetes_logs_transform]
      request:
        headers:
          X-Scope-OrgID: "1"
      endpoint: http://loki-gateway.monitoring.svc.cluster.local
      encoding:
        codec: json
      labels:
        container: "container"
        namespace: "namespace"
        pod: "pod"
        node: "node"
        log_type: "kubernetes"
      batch:
        max_bytes: 1048576
        timeout_secs: 5
      out_of_order_action: rewrite_timestamp

    loki_talos_kernel:
      type: loki
      inputs: [talos_kernel_transform]
      endpoint: http://loki-gateway.monitoring.svc.cluster.local
      encoding:
        codec: json
        except_fields: [__host]
      labels:
        hostname: "node"
        facility: "facility"
        log_type: "talos_kernel"
      batch:
        max_bytes: 1048576
        timeout_secs: 5
      out_of_order_action: rewrite_timestamp

    loki_talos_service:
      type: loki
      inputs: [talos_service_transform]
      endpoint: http://loki-gateway.monitoring.svc.cluster.local
      encoding:
        codec: json
        except_fields: [__host]
      labels:
        hostname: "node"
        service: "service"
        log_type: "talos_service"
      batch:
        max_bytes: 1048576
        timeout_secs: 5
      out_of_order_action: rewrite_timestamp

    prometheus:
      type: prometheus_exporter
      inputs:
        - internal_metrics
        - kubernetes_log_metrics
        - nginx_logs_metrics
      address: "0.0.0.0:9598"


tolerations:
  - operator: Exists

service:
  type: LoadBalancer
  ports:
    - name: prom-exporter
      port: 9598
      targetPort: 9598
      protocol: TCP
    - name: tailscale-logs
      port: 8088
      targetPort: 8088
      protocol: TCP
    - name: talos-kernel
      port: 6050
      targetPort: 6050
      protocol: UDP
    - name: talos-service
      port: 6051
      targetPort: 6051
      protocol: UDP

resources:
  limits:
    cpu: 500m
    memory: 256Mi
  requests:
    cpu: 100m
    memory: 128Mi
