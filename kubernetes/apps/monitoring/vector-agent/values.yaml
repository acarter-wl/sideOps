deploymentMode: SimpleScalable

loki:
  auth_enabled: false
  commonConfig:
    ring:
      kvstore:
        store: memberlist

  limits_config:
    retention_period: 720h
    max_query_parallelism: 128
    max_query_length: 721h
    max_streams_per_user: 10000

  ingester:
    chunk_encoding: snappy
    # Removed max_global_streams fields that caused errors

  querier:
    query_ingesters_within: 3h
    max_concurrent: 10

  schemaConfig:
    configs:
      - from: "2024-04-01"
        store: tsdb
        object_store: s3
        schema: v13
        index:
          prefix: loki_index_
          period: 24h

  storage_config:
    aws:
      s3:
        bucketnames: ceph-chunks
        endpoint: http://rook-ceph-rgw-ceph-objectstore.monitoring.svc.cluster.local
        region: us-east-1
        access_key_id: ${S3_ACCESS_KEY}
        secret_access_key: ${S3_SECRET_KEY}
        insecure: true
        s3forcepathstyle: true

    # Fixed these sections to match expected schema
    boltdb_shipper:
      active_index_directory: /data/loki/index
      cache_location: /data/loki/index_cache
      shared_store: s3

    # Changed to match correct field names
    tsdb:
      dir: /data/loki/tsdb

  table_manager:
    retention_deletes_enabled: true
    retention_period: 720h

  # Moved compactor to the correct location
  compactor:
    working_directory: /data/loki/compactor
    shared_store: s3

compactor:
  persistence:
    enabled: true
    mountPath: /var/loki/compactor
    accessModes:
      - ReadWriteOnce
    size: 20Gi
    storageClass: ceph-block

backend:
  replicas: 2
read:
  replicas: 2
write:
  replicas: 3

minio:
  enabled: false

extraEnvFrom:
  - secretRef:
      name: loki-s3-creds

resources:
  requests:
    cpu: 100m
    memory: 512Mi
  limits:
    cpu: 500m
    memory: 2Gi

tolerations:
  - operator: Exists
