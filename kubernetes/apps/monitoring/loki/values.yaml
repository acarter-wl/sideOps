# Use single unified configuration for Loki
loki:
  # Remove duplicate settings - only use structuredConfig
  structuredConfig:
    auth_enabled: false
    server:
      http_listen_port: 3100
    common:
      replication_factor: 1
      path_prefix: /var/loki
      storage:
        filesystem:
          directory: /var/loki/chunks
    schema_config:
      configs:
        - from: "2024-04-01"
          store: boltdb-shipper
          object_store: filesystem
          schema: v11
          index:
            prefix: index_
            period: 24h
    table_manager:
      retention_deletes_enabled: true
      retention_period: 168h # 7 days
    limits_config:
      enforce_metric_name: false
      reject_old_samples: true
      reject_old_samples_max_age: 168h
      max_look_back_period: 24h
      ingestion_rate_mb: 10
      ingestion_burst_size_mb: 20

# Set these all to 0 for SingleBinary mode
backend:
  replicas: 0
read:
  replicas: 0
write:
  replicas: 0
ingester:
  replicas: 0
querier:
  replicas: 0
queryFrontend:
  replicas: 0
queryScheduler:
  replicas: 0
distributor:
  replicas: 0
compactor:
  replicas: 0
indexGateway:
  replicas: 0
bloomCompactor:
  replicas: 0
bloomGateway:
  replicas: 0

# Make sure singleBinary mode is properly configured
singleBinary:
  replicas: 1
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 1000m
      memory: 2Gi # Reduced from 4Gi to prevent OOM issues
  extraPorts:
    - name: http
      containerPort: 3100
  extraEnv:
    - name: GOMEMLIMIT
      value: 1750MiB # Reduced from 3750MiB
  persistence:
    enabled: true
    size: 50Gi
    storageClassName: ceph-block

# Configure the gateway properly for SingleBinary mode
gateway:
  enabled: true
  replicas: 1
  nginxConfig:
    file: |
      worker_processes  1;
      events {
        worker_connections 1024;
      }
      http {
        server {
          listen 80;
          # Direct all traffic to the single binary Loki
          location ~ /loki/api/.* {
            proxy_pass http://loki.monitoring.svc.cluster.local:3100$request_uri;
          }
        }
      }

# Ensure Service is properly defined
service:
  name: loki
  type: ClusterIP
  port: 3100

serviceMonitor:
  enabled: true
  interval: 30s
  additionalLabels:
    release: kube-prometheus-stack

# Disable MinIO as we're using filesystem storage
minio:
  enabled: false
