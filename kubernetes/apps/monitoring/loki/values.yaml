deploymentMode: SimpleScalable

# Using custom Loki config
loki:
  existingConfigMap: loki-custom-config
  auth_enabled: false

# Add service configuration for memberlist
service:
  memberlist:
    # Ensure memberlist service is created
    enabled: true

backend:
  replicas: 2
  persistence:
    enabled: true
    size: 20Gi
    storageClassName: ceph-block
  extraEnv:
    - name: AWS_ACCESS_KEY_ID
      valueFrom:
        secretKeyRef:
          name: minio-credentials
          key: access_key
    - name: AWS_SECRET_ACCESS_KEY
      valueFrom:
        secretKeyRef:
          name: minio-credentials
          key: secret_key
  command:
    - /bin/sh
    - -c
    - /etc/loki/hosts-patch.sh /usr/bin/loki -config.file=/etc/loki/config/config.yaml -target=backend
  extraVolumeMounts:
    - name: hosts-patch
      mountPath: /etc/loki/hosts-patch.sh
      subPath: hosts-patch.sh
  extraVolumes:
    - name: hosts-patch
      configMap:
        name: loki-minio-hosts-patch
        defaultMode: 0755

read:
  replicas: 2
  persistence:
    enabled: true
    size: 20Gi
    storageClassName: ceph-block
  extraEnv:
    - name: AWS_ACCESS_KEY_ID
      valueFrom:
        secretKeyRef:
          name: minio-credentials
          key: access_key
    - name: AWS_SECRET_ACCESS_KEY
      valueFrom:
        secretKeyRef:
          name: minio-credentials
          key: secret_key

write:
  replicas: 3
  persistence:
    enabled: true
    size: 50Gi
    storageClassName: ceph-block
  extraEnv:
    - name: AWS_ACCESS_KEY_ID
      valueFrom:
        secretKeyRef:
          name: minio-credentials
          key: access_key
    - name: AWS_SECRET_ACCESS_KEY
      valueFrom:
        secretKeyRef:
          name: minio-credentials
          key: secret_key
  command:
    - /bin/sh
    - -c
    - /etc/loki/hosts-patch.sh /usr/bin/loki -config.file=/etc/loki/config/config.yaml -target=write
  extraVolumeMounts:
    - name: hosts-patch
      mountPath: /etc/loki/hosts-patch.sh
      subPath: hosts-patch.sh
  extraVolumes:
    - name: hosts-patch
      configMap:
        name: loki-minio-hosts-patch
        defaultMode: 0755

scheduler:
  enabled: true
  replicas: 2
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 250m
      memory: 256Mi
  extraEnv:
    - name: AWS_ACCESS_KEY_ID
      valueFrom:
        secretKeyRef:
          name: minio-credentials
          key: access_key
    - name: AWS_SECRET_ACCESS_KEY
      valueFrom:
        secretKeyRef:
          name: minio-credentials
          key: secret_key

# Disable built-in Minio
minio:
  enabled: false

gateway:
  enabled: true
  auth_enabled: false
  service:
    type: LoadBalancer
  extraEnv:
    - name: AWS_ACCESS_KEY_ID
      valueFrom:
        secretKeyRef:
          name: minio-credentials
          key: access_key
    - name: AWS_SECRET_ACCESS_KEY
      valueFrom:
        secretKeyRef:
          name: minio-credentials
          key: secret_key

monitoring:
  dashboards:
    enabled: true
  rules:
    enabled: true
  alerts:
    enabled: true
  serviceMonitor:
    enabled: true
