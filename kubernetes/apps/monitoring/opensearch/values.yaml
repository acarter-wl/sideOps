clusterName: "opensearch-cluster"
nodeGroup: "master"
replicas: 1

resources:
  requests:
    cpu: "1"
    memory: "1Gi"
  limits:
    cpu: "2"
    memory: "2Gi"

persistence:
  enabled: true
  storageClass: "ceph-block"
  accessModes:
    - ReadWriteOnce
  size: 30Gi

opensearchJavaOpts: "-Xmx1g -Xms1g"
singleNode: true

# Enable security with proper certificates
extraEnvs:
  - name: "DISABLE_INSTALL_DEMO_CONFIG"
    value: "true"
  - name: "bootstrap.memory_lock"
    value: "true"

config:
  opensearch.yml: |
    cluster.name: opensearch-cluster
    discovery.type: single-node
    network.host: 0.0.0.0

    # Transport layer security
    plugins.security.ssl.transport.pemcert_filepath: /usr/share/opensearch/config/node-certs/tls.crt
    plugins.security.ssl.transport.pemkey_filepath: /usr/share/opensearch/config/node-certs/tls.key
    plugins.security.ssl.transport.pemtrustedcas_filepath: /usr/share/opensearch/config/node-certs/ca.crt
    plugins.security.ssl.transport.enforce_hostname_verification: false

    # HTTP layer security
    plugins.security.ssl.http.enabled: true
    plugins.security.ssl.http.pemcert_filepath: /usr/share/opensearch/config/node-certs/tls.crt
    plugins.security.ssl.http.pemkey_filepath: /usr/share/opensearch/config/node-certs/tls.key
    plugins.security.ssl.http.pemtrustedcas_filepath: /usr/share/opensearch/config/node-certs/ca.crt

    # Security settings
    plugins.security.allow_default_init_securityindex: true
    plugins.security.authcz.admin_dn:
      - "CN=admin,O=admin,OU=opensearch"
    plugins.security.nodes_dn:
      - "CN=opensearch-cluster-master,O=cluster,OU=opensearch"

    # Enable security features
    plugins.security.audit.type: internal_opensearch
    plugins.security.enable_snapshot_restore_privilege: true
    plugins.security.check_snapshot_restore_write_privileges: true
    plugins.security.restapi.roles_enabled: ["all_access", "security_rest_api_access"]

extraVolumes:
  - name: node-certs
    secret:
      secretName: opensearch-node-cert
  - name: admin-certs
    secret:
      secretName: opensearch-admin-cert
  - name: admin-credentials
    secret:
      secretName: opensearch-cluster-master-credentials

extraVolumeMounts:
  - name: node-certs
    mountPath: /usr/share/opensearch/config/node-certs
    readOnly: true
  - name: admin-certs
    mountPath: /usr/share/opensearch/config/admin-certs
    readOnly: true
  - name: admin-credentials
    mountPath: /usr/share/opensearch/config/opensearch-security/admin-creds
    readOnly: true

# Security configuration
securityConfig:
  enabled: true
  adminCredentials:
    username: admin
    password: admin
    createSecret: false
    secret:
      name: "opensearch-cluster-master-credentials"

networkHost: "0.0.0.0"

dashboards:
  enabled: false

antiAffinity: "soft"

prometheus:
  enabled: true
  serviceMonitor:
    enabled: true
    labels:
      release: kube-prometheus-stack

service:
  type: ClusterIP
  httpPort: 9200
  transportPort: 9300

ingress:
  enabled: true
  hosts:
    - host: opensearch.wakkalabs.com
      paths:
        - path: /
          pathType: Prefix
          backend:
            service:
              name: opensearch-cluster-master
              port:
                number: 9200

podSecurityContext:
  fsGroup: 1000
  runAsUser: 1000

securityContext:
  capabilities:
    drop:
      - ALL
  runAsNonRoot: true
  runAsUser: 1000

lifecycle:
  preStop:
    exec:
      command:
        - bash
        - -c
        - >
          set -e sleep 5
