clusterName: "opensearch-cluster"
nodeGroup: "master"

# For a homelab environment, a single replica is often sufficient
replicas: 1

# Set resources based on your available capacity - adjust as needed
resources:
  requests:
    cpu: "1"
    memory: "1Gi"
  limits:
    cpu: "2"
    memory: "2Gi"

# Configure persistence
persistence:
  enabled: true
  # Use your default storage class or specify one
  storageClass: "ceph-block"
  accessModes:
    - ReadWriteOnce
  size: 30Gi

# Set Java heap size - adjust based on your available memory
opensearchJavaOpts: "-Xmx1g -Xms1g"

# Important for single-node deployments
singleNode: true

# Security configuration - reference external secrets
securityConfig:
  enabled: true
  actionGroupsSecret: ""
  configSecret: ""
  internalUsersSecret: ""
  rolesSecret: ""
  rolesMappingSecret: ""
  tenantConfigSecret: ""
  adminCredentials:
    # Reference the existing external secret instead of creating one
    username: admin
    password: admin
    createSecret: false
    secret:
      name: "opensearch-cluster-master-credentials"

# Network settings
networkHost: "0.0.0.0"

# For homelab environments, enable security but disable demo config
extraEnvs:
  - name: "DISABLE_INSTALL_DEMO_CONFIG"
    value: "true"
  - name: "bootstrap.memory_lock"
    value: "true"
# Allow the security plugin to run (remove DISABLE_SECURITY_PLUGIN env var)

# Settings that take precedence over opensearch.yml
config:
  opensearch.yml: |
    cluster.name: opensearch-cluster
    discovery.type: single-node
    network.host: 0.0.0.0

    # Transport layer security
    plugins.security.ssl.transport.pemcert_filepath: /usr/share/opensearch/config/node-certs/tls.crt
    plugins.security.ssl.transport.pemkey_filepath: /usr/share/opensearch/config/node-certs/tls.key
    plugins.security.ssl.transport.pemtrustedcas_filepath: /usr/share/opensearch/config/node-certs/ca.crt
    plugins.security.ssl.transport.enforce_hostname_verification: false

    # HTTP layer security
    plugins.security.ssl.http.enabled: true
    plugins.security.ssl.http.pemcert_filepath: /usr/share/opensearch/config/node-certs/tls.crt
    plugins.security.ssl.http.pemkey_filepath: /usr/share/opensearch/config/node-certs/tls.key
    plugins.security.ssl.http.pemtrustedcas_filepath: /usr/share/opensearch/config/node-certs/ca.crt

    # Security settings
    plugins.security.allow_default_init_securityindex: true
    plugins.security.authcz.admin_dn:
      - "CN=admin,O=admin,OU=opensearch"
    plugins.security.nodes_dn:
      - "CN=opensearch-cluster-master,O=cluster,OU=opensearch"

# Dashboard settings - set to false since we're deploying separate dashboards
dashboards:
  enabled: false

# Mount volumes for certificates and credentials - FIXED DUPLICATE ISSUE
extraVolumes:
  - name: node-certs
    secret:
      secretName: opensearch-node-cert
  - name: admin-certs
    secret:
      secretName: opensearch-admin-cert
  - name: admin-credentials
    secret:
      secretName: opensearch-cluster-master-credentials

extraVolumeMounts:
  - name: node-certs
    mountPath: /usr/share/opensearch/config/node-certs
    readOnly: true
  - name: admin-certs
    mountPath: /usr/share/opensearch/config/admin-certs
    readOnly: true
  - name: admin-credentials
    mountPath: /usr/share/opensearch/config/opensearch-security/admin-creds
    readOnly: true

# Add basic anti-affinity to improve reliability
antiAffinity: "soft"

# Prometheus metrics support
prometheus:
  enabled: true
  serviceMonitor:
    enabled: true
    labels:
      release: kube-prometheus-stack

# Configure service
service:
  type: ClusterIP
  httpPort: 9200
  transportPort: 9300

# Fix the ingress configuration - proper format for the chart
ingress:
  enabled: false

# Add necessary environment variables for Kubernetes
extraInitContainers: []
extraContainers: []

# Security context settings
podSecurityContext:
  fsGroup: 1000
  runAsUser: 1000

# Security context for container level
securityContext:
  capabilities:
    drop:
      - ALL
  runAsNonRoot: true
  runAsUser: 1000

# Lifecycle hooks
lifecycle:
  preStop:
    exec:
      command:
        - bash
        - -c
        - >
          set -e sleep 5
