configuration:
  provider: aws
  backupStorageLocation:
    bucket: bucket0-0
    name: rook-ceph  # Changed to match extraObjects
    default: true
    config:
      region: us-east-1  # Changed to match your extraObjects
      s3ForcePathStyle: true
      s3Url: http://s3ceph.wakkalabs.com
  volumeSnapshotLocation:
    name: csi-snapshots
    provider: aws
    config:
      region: us-east-1  # Changed to valid AWS region
  # resticRepository should be defined in a VolumeSnapshotLocation
initContainers:
  - name: velero-plugin-for-aws
    image: velero/velero-plugin-for-aws:v1.7.0  # Updated to latest stable
    imagePullPolicy: IfNotPresent
    volumeMounts:
      - mountPath: /target
        name: plugins
  - name: velero-plugin-for-csi
    image: velero/velero-plugin-for-csi:v0.7.0  # Updated to latest stable
    imagePullPolicy: IfNotPresent
    volumeMounts:
      - mountPath: /target
        name: plugins
  - name: nfs-mount
    image: alpine:3.19
    command: ["/bin/sh", "-c"]
    args:
      - |
        apk add --no-cache nfs-utils
        mkdir -p /mnt/velero-nfs
        echo "Mounting NFS share..."
        mount -v -o vers=4,nolock 192.168.100.94:/mnt/zpool-a/root-ds/backups /mnt/velero-nfs || echo "NFS mount failed, will retry"
        echo "NFS mount complete"
        # Using tail instead of sleep to keep container running
        tail -f /dev/null
    securityContext:
      privileged: true  # Consider using more restricted capabilities if possible
    volumeMounts:
      - mountPath: /mnt/velero-nfs
        name: velero-nfs
extraVolumes:
  - name: velero-nfs
    nfs:
      server: 192.168.100.94
      path: /mnt/zpool-a/root-ds/backups
extraVolumeMounts:
  - mountPath: /mnt/velero-nfs
    name: velero-nfs
deployNodeAgent: true

# Add credentials configuration to use the cloud-credentials secret
credentials:
  useSecret: true
  name: cloud-credentials
  existingSecret: cloud-credentials

resources:
  requests:
    cpu: 125m
    memory: 128Mi
  limits:
    cpu: 1000m
    memory: 512Mi
metrics:
  enabled: true
backupsEnabled: true
snapshotsEnabled: true
features:
  - EnableCSI
extraObjects:
  - apiVersion: velero.io/v1
    kind: BackupStorageLocation
    metadata:
      name: rook-ceph
      namespace: velero
    spec:
      provider: aws
      objectStorage:
        bucket: bucket0-0
      config:
        region: us-east-1
        s3ForcePathStyle: true
        s3Url: http://s3ceph.wakkalabs.com
      accessMode: ReadWrite
      default: true
  - apiVersion: velero.io/v1
    kind: BackupStorageLocation
    metadata:
      name: nfs-restic
      namespace: velero
    spec:
      provider: velero.io/local
      objectStorage:
        bucket: velero-nfs
      config:
        path: /mnt/velero-nfs/velero-metadata
      accessMode: ReadWrite
      default: false
  # Adding a proper VolumeSnapshotLocation for your resticRepository
  - apiVersion: velero.io/v1
    kind: VolumeSnapshotLocation
    metadata:
      name: nfs-restic
      namespace: velero
    spec:
      provider: velero.io/local
      config:
        resticRepoPath: /mnt/velero-nfs/restic-repo
