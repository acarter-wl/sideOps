apiVersion: batch/v1
kind: Job
metadata:
  name: kibana-setup
  namespace: logging
spec:
  template:
    spec:
      containers:
        - name: kibana-setup
          image: curlimages/curl:7.83.1
          command:
            - /bin/sh
            - -c
            - |
              # Wait for Kibana to be ready
              until curl -s http://logging-kb-http:5601/api/status | grep -q '"status":{.*"overall":{.*"level":"available"'; do
                echo "Waiting for Kibana..."
                sleep 10
              done

              # Create index pattern
              curl -X POST "http://logging-kb-http:5601/api/saved_objects/index-pattern/filebeat-*" \
                -H 'kbn-xsrf: true' \
                -H 'Content-Type: application/json' \
                -d '{"attributes":{"title":"filebeat-*","timeFieldName":"@timestamp"}}'

              echo "Setup completed"
      restartPolicy: OnFailure
  backoffLimit: 5
