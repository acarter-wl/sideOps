apiVersion: batch/v1
kind: Job
metadata:
  name: es-update-credentials
  namespace: logging
spec:
  ttlSecondsAfterFinished: 100
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: update-secrets
        image: bitnami/kubectl:latest
        command:
        - /bin/bash
        - -c
        - |
          set -e
          # Update elasticsearch-master-credentials secret
          kubectl -n logging patch secret elasticsearch-master-credentials --type=json -p='[{"op":"replace","path":"/data/password","value":"'$(echo -n "secret123" | base64)'"}]'
          
          # Update elastic-credentials secret too
          kubectl -n logging patch secret elastic-credentials --type=json -p='[{"op":"replace","path":"/data/password","value":"'$(echo -n "secret123" | base64)'"}]'
          
          # Restart pods to pick up new credentials
          kubectl -n logging delete pods -l app=filebeat-filebeat
          sleep 3
          kubectl -n logging delete pod elasticsearch-master-0
      serviceAccountName: es-update-credentials
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: es-update-credentials
  namespace: logging
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: es-update-credentials
  namespace: logging
rules:
  - apiGroups: [""]
    resources: ["secrets", "pods"]
    verbs: ["get", "patch", "delete", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: es-update-credentials
  namespace: logging
subjects:
  - kind: ServiceAccount
    name: es-update-credentials
    namespace: logging
roleRef:
  kind: Role
  name: es-update-credentials
  apiGroup: rbac.authorization.k8s.io